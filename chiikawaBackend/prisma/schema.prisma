generator client {
  provider = "prisma-client"
  output   = "../src/db/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model auth_users {
  id            Unsupported("ulid") @id @default(dbgenerated("gen_ulid()"))
  username      String?             @unique @db.VarChar(64)
  email         String              @unique @db.VarChar(256)
  password_hash String
  password_algo String              @default("bcrypt") @db.VarChar(64)
  created_at    DateTime            @default(now()) @db.Timestamptz(6)
  updated_at    DateTime            @default(now()) @db.Timestamptz(6)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model conversation_messages {
  id                    String                @id
  session_id            String
  msg_index             Int
  message               Json
  created_at            DateTime              @default(now()) @db.Timestamptz(6)
  updated_at            DateTime              @default(now()) @db.Timestamptz(6)
  conversation_sessions conversation_sessions @relation(fields: [session_id], references: [session_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_conversation_messages_created_at")
  @@index([session_id, msg_index], map: "idx_conversation_messages_session_id_index")
}

model conversation_sessions {
  session_id            String                  @id
  user_id               String?
  tenant_id             String?
  channel               conversation_channel
  title                 String?
  deleted               Boolean                 @default(false)
  started_at            DateTime                @db.Timestamptz(6)
  last_message_at       DateTime                @db.Timestamptz(6)
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @db.Timestamptz(6)
  metadata              Json?
  conversation_messages conversation_messages[]

  @@index([last_message_at(sort: Desc)], map: "idx_conversation_sessions_last_message_at")
  @@index([tenant_id], map: "idx_conversation_sessions_tenant_id")
  @@index([user_id], map: "idx_conversation_sessions_user_id")
}

model goose_db_version {
  id         Int      @id @default(autoincrement())
  version_id BigInt
  is_applied Boolean
  tstamp     DateTime @default(now()) @db.Timestamp(6)
}

model users {
  id           Unsupported("ulid") @id @default(dbgenerated("gen_ulid()"))
  username     String              @unique @db.VarChar(64)
  email        String              @unique @db.VarChar(256)
  display_name String?             @db.VarChar(256)
  avatar_url   String?             @db.VarChar(256)
  created_at   DateTime            @default(now()) @db.Timestamptz(6)
  updated_at   DateTime            @default(now()) @db.Timestamptz(6)
}

enum conversation_channel {
  web_chat @map("web-chat")
  voice
  api
}
